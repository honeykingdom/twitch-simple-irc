"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e,t=(e=require("tls"))&&"object"==typeof e&&"default"in e?e.default:e,n=require("net"),r=require("events"),s=require("tekko");function a(){return(a=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}var i,o=function(){return"justinfan"+Math.floor(1e5*Math.random()).toString().padStart(5,"0")},c=function(e){return e.startsWith("ACTION ")&&e.endsWith("")},m=function(e){return e.slice(8,-1)},u=function(e){return e.middle[0].slice(1)},d=!("undefined"==typeof process||!process.versions||!process.versions.node),g=["mod","emote-only","r9k","rituals","subs-only","msg-param-should-share-streak"],l=["tmi-sent-ts","bits","ban-duration","msg-param-cumulative-months","msg-param-months","msg-param-promo-gift-total","msg-param-streak-months","msg-param-viewerCount","msg-param-threshold"],p={"badge-info":"badgeInfo","display-name":"displayName","emote-sets":"emoteSets","room-id":"roomId","tmi-sent-ts":"tmiSentTs","user-id":"userId","target-msg-id":"targetMsgId","target-user-id":"targetUserId","msg-id":"msgId","system-msg":"systemMsg","emote-only":"emoteOnly","followers-only":"followersOnly","subs-only":"subsOnly","ban-duration":"banDuration","message-id":"messageId","thread-id":"threadId","msg-param-cumulative-months":"msgParamCumulativeMonths","msg-param-displayName":"msgParamDisplayName","msg-param-login":"msgParamLogin","msg-param-months":"msgParamMonths","msg-param-promo-gift-total":"msgParamPromoGiftTotal","msg-param-promo-name":"msgParamPromoName","msg-param-recipient-display-name":"msgParamRecipientDisplayName","msg-param-recipient-id":"msgParamRecipientId","msg-param-recipient-user-name":"msgParamRecipientUserName","msg-param-sender-login":"msgParamSenderLogin","msg-param-sender-name":"msgParamSenderName","msg-param-should-share-streak":"msgParamShouldShareStreak","msg-param-streak-months":"msgParamStreakMonths","msg-param-sub-plan":"msgParamSubPlan","msg-param-sub-plan-name":"msgParamSubPlanName","msg-param-viewerCount":"msgParamViewerCount","msg-param-ritual-name":"msgParamRitualName","msg-param-threshold":"msgParamThreshold"},h=["subscriber","turbo","user-type"],f=function(e){return void 0===e&&(e=""),e?e.split(",").reduce((function(e,t){var n,r=t.split("/");return a({},e,((n={})[r[0]]=r[1],n))}),{}):{}},v=function(e){return e?Object.entries(e).reduce((function(e,t){var n,r=t[0],s=t[1];return h.includes(r)?e:a({},e,((n={})[p[r]||r]=function(e,t){if("emotes"===e)return void 0===(n=t)&&(n=""),n?n.split("/").reduce((function(e,t){var n,r=t.split(":");return a({},e,((n={})[r[0]]=r[1].split(",").map((function(e){var t=e.split("-"),n=t[1];return{start:Number.parseInt(t[0],10),end:Number.parseInt(n,10)}})),n))}),{}):{};var n;if("badges"===e)return f(t);if("badge-info"===e)return f(t);if("followers-only"===e){var r=!1;return"-1"===t?r=!1:"0"===t?r=!0:"string"==typeof t&&(r=parseInt(t,10)),r}if("slow"===e){var s=!1;return"0"===t?s=!1:"string"==typeof t&&(s=parseInt(t,10)),s}return g.includes(e)?"1"===t:l.includes(e)?parseInt(t,10):"string"==typeof t?t.replace("\\s"," "):t}(r,s),n))}),{}):{}},S=function(e){var t=e.tags;return{raw:e.raw,channel:u(e),get tags(){return v(t)}}},P=function(e){var t=e.tags;return{raw:e.raw,message:e.trailing,channel:u(e),get tags(){return v(t)}}};(i=exports.Commands||(exports.Commands={})).REPLY001="001",i.PING="PING",i.PONG="PONG",i.JOIN="JOIN",i.PART="PART",i.PRIVMSG="PRIVMSG",i.NOTICE="NOTICE",i.USERNOTICE="USERNOTICE",i.GLOBALUSERSTATE="GLOBALUSERSTATE",i.USERSTATE="USERSTATE",i.ROOMSTATE="ROOMSTATE",i.CLEARCHAT="CLEARCHAT",i.CLEARMSG="CLEARMSG",i.HOSTTARGET="HOSTTARGET",i.WHISPER="WHISPER";var w,_=function(e){var r,i;function g(t){var n;return void 0===t&&(t={}),(n=e.call(this)||this).socket=null,n.globalUserState=null,n.channels={},n._connected=!1,n._connecting=!1,n._registered=!1,n._reconnectInterval=2e3,n.options=a({secure:!0,reconnect:!0},t),n}i=e,(r=g).prototype=Object.create(i.prototype),r.prototype.constructor=r,r.__proto__=i;var l,p=g.prototype;return p.connect=function(){try{var e=this,t=d?e._connectInNode():e._connectInBrowser();return Promise.resolve(t).then((function(){return e._register()}))}catch(e){return Promise.reject(e)}},p.disconnect=function(){this._connected&&(d?this.socket.destroy():this.socket.close(),this.socket=null,this._connected=!1,this._connecting=!1,this._registered=!1,this.emit("disconnect"))},p.reconnect=function(){var e=this;if(!this._connected){var t=Math.min(6e4,this._reconnectInterval);setTimeout((function(){try{return Promise.resolve(e.connect()).then((function(){e._connected&&e._registered?(e._reconnectInterval=2e3,Object.keys(e.channels).map((function(t){return e.join(t)}))):(e._reconnectInterval*=2,e.reconnect())}))}catch(e){return Promise.reject(e)}}),t)}},p.receiveRaw=function(e){var t=this;e.trim().split("\r\n").forEach((function(e){return t._handleMessage(e)}))},p.sendRaw=function(e){return!(null===this.socket||!e||(d?this.socket.write(e+"\r\n"):this.socket.send(e),0))},p.say=function(e,t){if(!t)return!1;var n=s.format({command:exports.Commands.PRIVMSG,middle:["#"+e],trailing:t});return this.sendRaw(n)},p.sendCommand=function(e,t,n){void 0===n&&(n="");var r=Array.isArray(n)?n.join(" "):n,a=s.format({command:exports.Commands.PRIVMSG,middle:["#"+e],trailing:"/"+t+" "+r});return this.sendRaw(a)},p.join=function(e){if(!this._registered)return!1;var t=s.format({command:exports.Commands.JOIN,middle:["#"+e]});return this.sendRaw(t)},p.part=function(e){if(!this._registered)return!1;var t=s.format({command:exports.Commands.PART,middle:["#"+e]});return this.sendRaw(t)},p._handleMessage=function(e){var t=s.parse(e);t.raw=e;var n=t.command;if(n===exports.Commands.PING)return this.sendRaw(exports.Commands.PONG+" :tmi.twitch.tv"),void this.emit("ping",{raw:e});if(n===exports.Commands.REPLY001)return this.options.name=t.middle[0],this._registered=!0,void this.emit("register");if(n!==exports.Commands.PRIVMSG){if(n===exports.Commands.USERSTATE){var r=u(t),a=S(t);return this._updateUserState(r,a.tags),void this.emit("userstate",a)}if(n!==exports.Commands.JOIN)if(n!==exports.Commands.PART){if(n===exports.Commands.ROOMSTATE){var i=u(t),o=S(t);return this._updateRoomState(i,o.tags),void this.emit("roomstate",o)}if(n!==exports.Commands.NOTICE)if(n!==exports.Commands.USERNOTICE)if(n!==exports.Commands.CLEARCHAT)if(n!==exports.Commands.CLEARMSG)if(n!==exports.Commands.HOSTTARGET)if(n!==exports.Commands.WHISPER){var d,g;if(n===exports.Commands.GLOBALUSERSTATE){var l=function(e){var t=e.tags;return{raw:e.raw,get tags(){return v(t)}}}(t);return this._updateGlobalUserState(l.tags),void this.emit("globaluserstate",l)}}else{var p=(g=(d=t).tags,{raw:d.raw,message:d.trailing,channel:d.middle[0],user:d.prefix.name,get tags(){return v(g)}});this.emit("whisper",p)}else{var h=P(t);this.emit("hosttarget",h)}else{var f=P(t);this.emit("clearmessage",f)}else{var w=P(t);this.emit("clearchat",w)}else{var _=P(t);this.emit("usernotice",_)}else{var R=P(t);this.emit("notice",R)}}else{var b=u(t);this.emit("part",{channel:b})}else{var y=u(t);this.emit("join",{channel:y})}}else{var T=function(e){var t=e.raw,n=e.trailing,r=e.tags,s=e.prefix.name,a=c(n);return{raw:t,message:a?m(n):n,channel:u(e),user:s,get tags(){return v(r)},isAction:a}}(t);this.emit("message",T)}},p._connectInNode=function(){var e=this,r="irc.chat.twitch.tv",s=this.options.secure?6697:6667;return new Promise((function(a,i){e._connecting=!0;var o=function(){e._connecting=!1,e._connected=!0,e.emit("connect"),a()};e.options.secure?e.socket=t.connect(s,r,{},o):(e.socket=new n.Socket,e.socket.connect(s,r,o)),e.socket.on("error",(function(t){e._connected=!1,e._connecting=!1,e.emit("disconnect",t),i(t),e.options.reconnect&&e.reconnect()})),e.socket.on("data",(function(t){e.receiveRaw(t.toString())})),e.socket.on("close",(function(){e._connected=!1,e._connecting=!1,e._registered=!1,e.emit("disconnect")}))}))},p._connectInBrowser=function(){var e=this,t=this.options.secure?"wss://irc-ws.chat.twitch.tv:443":"ws://irc-ws.chat.twitch.tv:80";return new Promise((function(n,r){e._connecting=!0,e.socket=new WebSocket(t),e.socket.onopen=function(){e._connected=!0,e._connecting=!1,e.emit("connect"),n()},e.socket.onmessage=function(t){return e.receiveRaw(t.data)},e.socket.onerror=function(){},e.socket.onclose=function(t){var n=t.wasClean,s=t.code,a=t.reason;if(e.socket=null,e._connected=!1,e._connecting=!1,e._registered=!1,n)e.emit("disconnect");else{var i=new Error("["+s+"] "+a);e.emit("disconnect",i),r(i)}e.options.reconnect&&e.reconnect()}}))},p._register=function(){var e=this;if(!this._connected)return Promise.reject();if(this._registered)return Promise.resolve();var t=this.options,n=t.auth,r=t.name||o(),s=n?"oauth:"+n:"SCHMOOPIIE";return this.sendRaw("CAP REQ :twitch.tv/tags twitch.tv/commands"),this.sendRaw("PASS "+s),this.sendRaw("NICK "+r),new Promise((function(t,n){var r=function n(){t(),e.off("register",n)};e.on("register",r),setTimeout((function(){n(),e.off("register",r)}),1e4)}))},p._updateGlobalUserState=function(e){this.globalUserState=a({},this.globalUserState,e)},p._updateUserState=function(e,t){var n;this.channels=a({},this.channels,((n={})[e]=a({},this.channels[e],{userState:t}),n))},p._updateRoomState=function(e,t){var n;this.channels=a({},this.channels,((n={})[e]=a({},this.channels[e],{roomState:t}),n))},(l=[{key:"connected",get:function(){return this._connected}},{key:"connecting",get:function(){return this._connecting}},{key:"registered",get:function(){return this._registered}}])&&function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(g.prototype,l),g}(r.EventEmitter);(w=exports.UserNoticeType||(exports.UserNoticeType={})).sub="sub",w.resub="resub",w.subgift="subgift",w.anonsubgift="anonsubgift",w.submysterygift="submysterygift",w.giftpaidupgrade="giftpaidupgrade",w.rewardgift="rewardgift",w.anongiftpaidupgrade="anongiftpaidupgrade",w.raid="raid",w.unraid="unraid",w.ritual="ritual",w.bitsbadgetier="bitsbadgetier",exports.Client=_,exports.getChannelFromMessage=u,exports.getIsAction=c,exports.getRandomUsername=o,exports.isNode=d,exports.normalizeActionMessage=m,exports.parseMessageTags=v;
//# sourceMappingURL=twitch-simple-irc.cjs.production.min.js.map
